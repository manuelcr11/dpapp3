package com.example.dbapp

import android.location.Geocoder
import androidx.appcompat.app.AppCompatActivity
import android.os.Bundle
import android.widget.Button
import android.widget.EditText
import android.widget.Toast
import com.google.android.gms.maps.CameraUpdateFactory
import com.google.android.gms.maps.GoogleMap
import com.google.android.gms.maps.OnMapReadyCallback
import com.google.android.gms.maps.SupportMapFragment
import com.google.android.gms.maps.model.LatLng
import com.google.android.gms.maps.model.MarkerOptions
import java.util.Locale

class MapaActivity : AppCompatActivity(), OnMapReadyCallback {

    private lateinit var gMap: GoogleMap
    private lateinit var geocoder: Geocoder

    override fun onCreate(savedInstanceState: Bundle?) {
        super.onCreate(savedInstanceState)
        setContentView(R.layout.activity_mapa)

        geocoder = Geocoder(this, Locale.getDefault())

        val mapFragment = supportFragmentManager
            .findFragmentById(R.id.map) as SupportMapFragment
        mapFragment.getMapAsync(this)

        val txtLat = findViewById<EditText>(R.id.txtLat)
        val txtLon = findViewById<EditText>(R.id.txtLon)
        val txtPlace = findViewById<EditText>(R.id.txtPlace)
        val btnBuscar = findViewById<Button>(R.id.btnBuscar)

        btnBuscar.setOnClickListener {

            val place = txtPlace.text.toString()
            val lat = txtLat.text.toString()
            val lon = txtLon.text.toString()

            when {
                place.isNotEmpty() -> buscarPorNombre(place)
                lat.isNotEmpty() && lon.isNotEmpty() -> buscarPorCoordenadas(lat.toDouble(), lon.toDouble())
                else -> Toast.makeText(this, "Ingresa datos válidos", Toast.LENGTH_SHORT).show()
            }
        }
    }

    override fun onMapReady(map: GoogleMap) {
        gMap = map
    }

    private fun buscarPorCoordenadas(lat: Double, lon: Double) {
        val location = LatLng(lat, lon)
        mostrarEnMapa(location)

        val addresses = geocoder.getFromLocation(lat, lon, 1)

        if (!addresses.isNullOrEmpty()) {
            val dir = addresses[0].getAddressLine(0)
            Toast.makeText(this, dir, Toast.LENGTH_LONG).show()
        }
    }

    private fun buscarPorNombre(nombre: String) {
        val resultados = geocoder.getFromLocationName(nombre, 1)

        if (!resultados.isNullOrEmpty()) {
            val lat = resultados[0].latitude
            val lon = resultados[0].longitude
            val direccion = resultados[0].getAddressLine(0)

            val location = LatLng(lat, lon)
            mostrarEnMapa(location)

            Toast.makeText(this, direccion, Toast.LENGTH_LONG).show()
        }
    }

    private fun mostrarEnMapa(location: LatLng) {
        gMap.clear()
        gMap.addMarker(MarkerOptions().position(location).title("Ubicación encontrada"))
        gMap.moveCamera(CameraUpdateFactory.newLatLngZoom(location, 17f))
    }
}
